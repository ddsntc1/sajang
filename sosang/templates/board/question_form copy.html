{% extends "base.html" %}
{% block content %}
<div class="container">
    <h5 class="my-3 border-bottom pb-2">게시글 등록</h5>
    <form method="post" enctype="multipart/form-data" class="post-form my-3">
        {% csrf_token %}
        {{ form.media }}  <!-- Summernote media 추가 -->
        <!-- 오류표시 start -->
        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
                {% for field in form %}
                    {% if field.errors %}
                    <strong>{{ field.label }}</strong>
                    {{ field.errors }}
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- 게시판 선택 -->
        <div class="form-group mb-3">
            <label for="category">게시판</label>
            <select name="category" id="category" class="form-control" 
                    {% if form.instance.id %}disabled{% endif %}>
                <option value="">게시판 선택</option>
                {% for category in form.fields.category.queryset %}
                <option value="{{category.pk}}" 
                        {% if form.category.value|stringformat:"s" == category.pk|stringformat:"s" %}
                        selected
                        {% endif %}>
                    {{category.name}}
                </option>
                {% endfor %}
            </select>
            {% if form.instance.id %}
            <input type="hidden" name="category" value="{{ form.instance.category.id }}">
            {% endif %}
        </div>

        <!-- 게시글 제목 -->
        <div class="form-group mb-3">
            <label for="subject">제목</label>
            <input type="text" name="subject" id="subject" class="form-control" 
                   value="{{form.subject.value|default_if_none:''}}">
        </div>
        
        <!-- 게시글 내용 -->
        <div class="form-group mb-3">
            <label for="content">내용</label>
            {{ form.content }} 
        </div>

        <div class="form-group mb-3">
            <small class="text-muted d-block mt-1">이미지 최대 파일 크기: 5MB</small>
        </div>

        <button type="submit" class="btn btn-primary">저장하기</button>
    </form>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const boardTypeSelect = document.getElementById('board_type');
        const categorySelect = document.getElementById('category');
    
        boardTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            if (!selectedType) {
                categorySelect.disabled = true;
                categorySelect.innerHTML = '<option value="">게시판을 선택하세요</option>';
                return;
            }
    
            fetch(`/api/categories/?type=${selectedType}`)
                .then(response => response.json())
                .then(categories => {
                    categorySelect.innerHTML = '<option value="">게시판을 선택하세요</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                    categorySelect.disabled = false;
                });
        });
    
        // Summernote 설정 유지
        $('#content').summernote({
            height: 300,
            maxFileSize: 5 * 1024 * 1024,
            callbacks: {
                onImageUploadError: function(msg) {
                    if (msg === 'File is too large') {
                        alert('이미지 크기는 5MB를 초과할 수 없습니다.');
                    }
                }
            }
        });
    });
</script>
{% endblock %}